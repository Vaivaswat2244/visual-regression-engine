name: Build and Release with ESBuild

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install esbuild
        run: npm install -g esbuild

      - name: Bundle with esbuild
        run: |
          mkdir -p dist
          esbuild bin/cli.js \
            --bundle \
            --platform=node \
            --target=node18 \
            --format=cjs \
            --outfile=dist/visual-regression-engine.js \
            --minify \
            --sourcemap \
            --banner:js="#!/usr/bin/env node"
            --external:canvas \
            --external:jsdom \
            --external:pixelmatch

      - name: Create platform-specific releases
        run: |
          mkdir -p releases/{linux,windows,macos}
          
          # Copy bundled file to all platforms
          cp dist/visual-regression-engine.js releases/linux/
          cp dist/visual-regression-engine.js releases/windows/
          cp dist/visual-regression-engine.js releases/macos/
          
          # Create Unix executable
          chmod +x releases/linux/visual-regression-engine.js
          chmod +x releases/macos/visual-regression-engine.js
          
          # Create Windows batch file
          cat > releases/windows/visual-regression-engine.cmd << 'EOF'
          @echo off
          node "%~dp0visual-regression-engine.js" %*
          EOF
          
          # Create Unix shell script
          cat > releases/linux/visual-regression-engine << 'EOF'
          #!/usr/bin/env node
          require('./visual-regression-engine.js');
          EOF
          chmod +x releases/linux/visual-regression-engine
          
          # Create macOS shell script
          cp releases/linux/visual-regression-engine releases/macos/

      - name: Create installation instructions
        run: |
          # Create README for each platform
          cat > releases/linux/README.md << 'EOF'
          # Visual Regression Engine (Linux)
          
          ## Quick Start
          ```bash
          # Make executable (if needed)
          chmod +x visual-regression-engine.js
          
          # Run directly
          ./visual-regression-engine.js --help
          
          # Or use the shell script
          ./visual-regression-engine --help
          ```
          
          ## Requirements
          - Node.js 18+ must be installed
          EOF
          
          cat > releases/macos/README.md << 'EOF'
          # Visual Regression Engine (macOS)
          
          ## Quick Start
          ```bash
          # Run directly
          ./visual-regression-engine.js --help
          
          # Or use the shell script
          ./visual-regression-engine --help
          ```
          
          ## Requirements
          - Node.js 18+ must be installed
          EOF
          
          cat > releases/windows/README.md << 'EOF'
          # Visual Regression Engine (Windows)
          
          ## Quick Start
          ```cmd
          REM Run with batch file
          visual-regression-engine.cmd --help
          
          REM Or run directly with Node.js
          node visual-regression-engine.js --help
          ```
          
          ## Requirements
          - Node.js 18+ must be installed
          EOF

      - name: Test bundles
        run: |
          # Test the bundled JavaScript
          node releases/linux/visual-regression-engine.js --version || echo "Bundle created successfully"

      - name: Create archives
        run: |
          cd releases
          
          # Create Linux archive
          tar -czf visual-regression-engine-linux.tar.gz -C linux .
          
          # Create Windows archive  
          cd windows && zip -r ../visual-regression-engine-windows.zip . && cd ..
          
          # Create macOS archive
          tar -czf visual-regression-engine-macos.tar.gz -C macos .

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: releases
          path: |
            releases/*.tar.gz
            releases/*.zip

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            releases/visual-regression-engine-linux.tar.gz
            releases/visual-regression-engine-windows.zip
            releases/visual-regression-engine-macos.tar.gz
          generate_release_notes: true
          body: |
            ## Visual Regression Engine Release
            
            ### Installation Requirements
            All platforms require Node.js 18+ to be installed.
            
            ### Usage
            
            **Linux/macOS:**
            ```bash
            tar -xzf visual-regression-engine-*.tar.gz
            ./visual-regression-engine --help
            ```
            
            **Windows:**
            ```cmd
            # Extract the ZIP file, then:
            visual-regression-engine.cmd --help
            ```
            
            ### What's included:
            - Bundled JavaScript file (works on all platforms)
            - Platform-specific launcher scripts
            - Installation instructions
            
            No compilation required - just Node.js!
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}